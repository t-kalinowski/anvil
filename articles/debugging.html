<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Debugging • anvil</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Debugging">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">anvil</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/anvil.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/anvil.html">Get Started</a></li>
    <li><a class="dropdown-item" href="../articles/random-numbers.html">Random Number Generation</a></li>
    <li><a class="dropdown-item" href="../articles/type-promotion.html">Type Promotion</a></li>
    <li><a class="dropdown-item" href="../articles/primitives.html">Primitives Overview</a></li>
    <li><a class="dropdown-item" href="../articles/debugging.html">Debugging</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-technical" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Technical</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-technical">
<li><a class="dropdown-item" href="../articles/internals.html">Internals</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-xla/anvil/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Debugging</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-xla/anvil/blob/main/vignettes/debugging.Rmd" class="external-link"><code>vignettes/debugging.Rmd</code></a></small>
      <div class="d-none name"><code>debugging.Rmd</code></div>
    </div>

    
    
<p>The main benefit of {anvil} is that it allows you to compile R code
into an executable, which considerably increases execution speed. The
main drawback is that this makes it harder to debug code, because you
can’t rely on the R debugger to step through the function during
execution (only during tracing/compilation).</p>
<p>For this reason, {anvil} provides a <strong>debug mode</strong> that
allows you to perform abstract evaluation, which we will explain first.
Afterwards, we cover different ways to print values during
execution.</p>
<div class="section level2">
<h2 id="debug-mode">Debug Mode<a class="anchor" aria-label="anchor" href="#debug-mode"></a>
</h2>
<p>When {anvil} functions are executed without being wrapped in
<code><a href="../reference/jit.html">jit()</a></code>, they will run in debug mode and output a
<code>DebugBox</code> object, which essentially represents the type of
the output tensor.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-xla.github.io/anvil/" class="external-link">anvil</a></span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nv_tensor.html">nv_scalar</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../reference/nv_tensor.html">nv_tensor</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">y</span></span></code></pre></div>
<pre><code><span><span class="co">## f32{2,2}</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## f32{}</span></span></code></pre>
<p>To use debug mode, you can pass <code>AnvilTensor</code> and literals
(<code>1L</code>, <code>1.0</code>).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="../reference/nv_tensor.html">nv_scalar</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## f32{}</span></span></code></pre>
<p>If you only want to specify the abstract types, you can also directly
pass <code>DebugBox</code> objects:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/debug_box.html">debug_box</a></span><span class="op">(</span><span class="st">"f32"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="../reference/debug_box.html">debug_box</a></span><span class="op">(</span><span class="st">"f32"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## f32{2,1}</span></span></code></pre>
<p>You can even evaluate transformations like gradients in debug
mode:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/gradient.html">gradient</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span><span class="op">(</span><span class="fu"><a href="../reference/debug_box.html">debug_box</a></span><span class="op">(</span><span class="st">"f32"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $x</span></span>
<span><span class="co">## f32{2,2}</span></span></code></pre>
<p>Because this all happens in the R interpreter, you can also add
breakpoints to the code and step through it to identify bugs. However,
even if a program is valid and can be compiled, it might not work as
expected, e.g. because of logical bugs or invalid hyperparameters. For
this, it’s important to monitor (intermediate) values, which we will
cover in the next section.</p>
</div>
<div class="section level2">
<h2 id="printing-values">Printing Values<a class="anchor" aria-label="anchor" href="#printing-values"></a>
</h2>
<p>There are different ways to print values in {anvil} that might be
confusing at first. We will start with the naive way of simply inserting
<code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code> statements into the code of a
<code>jit</code>-compiled function.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f_jit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/jit.html">jit</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">x</span><span class="op">^</span><span class="fl">2</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>If we run this function, we see that not the actual value is printed,
but some <code>GraphBox</code> object. This <code>GraphBox</code> object
is passed around <strong>during tracing</strong> so that we can convert
the function into a <code>Graph</code> that is subsequently
compiled.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">f_jit</span><span class="op">(</span><span class="fu"><a href="../reference/nv_tensor.html">nv_tensor</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## GraphBox(GraphValue(AbstractTensor(dtype=f32?, shape=2x2)))</span></span></code></pre>
<pre><code><span><span class="co">## AnvilTensor </span></span>
<span><span class="co">##  15.0000</span></span>
<span><span class="co">## [ CPUf32{} ]</span></span></code></pre>
<p>Furthermore, if we call the function with identical input types, it
won’t be printed because the executable is retrieved from the cache.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">f_jit</span><span class="op">(</span><span class="fu"><a href="../reference/nv_tensor.html">nv_tensor</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">3</span>, shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## AnvilTensor </span></span>
<span><span class="co">##  7.0000</span></span>
<span><span class="co">## [ CPUf32{} ]</span></span></code></pre>
<p>If you want to get the actual content of the values during execution,
there are two options:</p>
<ol style="list-style-type: decimal">
<li>Ensure that the value to print is returned by the jit-compiled
function so it can be printed <strong>after</strong> execution. This
comes naturally when the <code>jit</code>-compiled function is called
within an R loop.</li>
<li>Using the special <code><a href="../reference/nv_print.html">nv_print()</a></code> function to print
<strong>during</strong> execution. This is useful when the value to
print is not naturally returned by the function.</li>
</ol>
<p>For illustrative purposes, we will count to 10 and print all
intermediate results.</p>
<p>In the first approach, we only <code>jit</code>-compile the update
function and iteratively call it in an R loop.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">add_one</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/jit.html">jit</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">1L</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nv_tensor.html">nv_scalar</a></span><span class="op">(</span><span class="fl">0L</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">add_one</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## AnvilTensor </span></span>
<span><span class="co">##  1</span></span>
<span><span class="co">## [ CPUi32{} ] </span></span>
<span><span class="co">## AnvilTensor </span></span>
<span><span class="co">##  2</span></span>
<span><span class="co">## [ CPUi32{} ] </span></span>
<span><span class="co">## AnvilTensor </span></span>
<span><span class="co">##  3</span></span>
<span><span class="co">## [ CPUi32{} ] </span></span>
<span><span class="co">## AnvilTensor </span></span>
<span><span class="co">##  4</span></span>
<span><span class="co">## [ CPUi32{} ] </span></span>
<span><span class="co">## AnvilTensor </span></span>
<span><span class="co">##  5</span></span>
<span><span class="co">## [ CPUi32{} ] </span></span>
<span><span class="co">## AnvilTensor </span></span>
<span><span class="co">##  6</span></span>
<span><span class="co">## [ CPUi32{} ] </span></span>
<span><span class="co">## AnvilTensor </span></span>
<span><span class="co">##  7</span></span>
<span><span class="co">## [ CPUi32{} ] </span></span>
<span><span class="co">## AnvilTensor </span></span>
<span><span class="co">##  8</span></span>
<span><span class="co">## [ CPUi32{} ] </span></span>
<span><span class="co">## AnvilTensor </span></span>
<span><span class="co">##  9</span></span>
<span><span class="co">## [ CPUi32{} ] </span></span>
<span><span class="co">## AnvilTensor </span></span>
<span><span class="co">##  10</span></span>
<span><span class="co">## [ CPUi32{} ]</span></span></code></pre>
<p>For the second approach, we use <code>nv_while</code> to implement
the loop.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/jit.html">jit</a></span><span class="op">(</span>\<span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">init</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nv_fill.html">nv_fill</a></span><span class="op">(</span><span class="fl">1L</span>, shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/nv_while.html">nv_while</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">init</span><span class="op">)</span>,</span>
<span>    \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;=</span> <span class="fl">10</span>,</span>
<span>    \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="../reference/nv_print.html">nv_print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span> <span class="op">+</span> <span class="fl">1L</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span>, device <span class="op">=</span> <span class="st">"cpu"</span><span class="op">)</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## AnvilTensor</span></span>
<span><span class="co">##  1</span></span>
<span><span class="co">## [ S32{} ]</span></span>
<span><span class="co">## AnvilTensor</span></span>
<span><span class="co">##  2</span></span>
<span><span class="co">## [ S32{} ]</span></span>
<span><span class="co">## AnvilTensor</span></span>
<span><span class="co">##  3</span></span>
<span><span class="co">## [ S32{} ]</span></span>
<span><span class="co">## AnvilTensor</span></span>
<span><span class="co">##  4</span></span>
<span><span class="co">## [ S32{} ]</span></span>
<span><span class="co">## AnvilTensor</span></span>
<span><span class="co">##  5</span></span>
<span><span class="co">## [ S32{} ]</span></span>
<span><span class="co">## AnvilTensor</span></span>
<span><span class="co">##  6</span></span>
<span><span class="co">## [ S32{} ]</span></span>
<span><span class="co">## AnvilTensor</span></span>
<span><span class="co">##  7</span></span>
<span><span class="co">## [ S32{} ]</span></span>
<span><span class="co">## AnvilTensor</span></span>
<span><span class="co">##  8</span></span>
<span><span class="co">## [ S32{} ]</span></span>
<span><span class="co">## AnvilTensor</span></span>
<span><span class="co">##  9</span></span>
<span><span class="co">## [ S32{} ]</span></span>
<span><span class="co">## AnvilTensor</span></span>
<span><span class="co">##  10</span></span>
<span><span class="co">## [ S32{} ]</span></span></code></pre>
<pre><code><span><span class="co">## $x</span></span>
<span><span class="co">## AnvilTensor </span></span>
<span><span class="co">##  11</span></span>
<span><span class="co">## [ CPUi32{} ]</span></span></code></pre>
<p>We will provide more formatting options in the future!</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sebastian Fischer, Daniel Falbel, Nikolai German.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
